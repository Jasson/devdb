ejabberd cluster的配置

如何添加一个ejabberd节点到ejabberd cluster集群中?

步骤:
1. 同步cookie
ejabberd的cookie放置在/usr/local/imserver/var/lib/ejabberd/.erlang.cookie中
所以应该把这个文件从第一台ejabberd服务器上copy到第二台的相同位置.
(可以同时把~/.erlang.cookie也更新成相同的内容)

sudo cp .erlang.cookie /root/.erlang.cookie
sudo cp .erlang.cookie /home/username/.erlang.cookie
sudo cp .erlang.cookie /usr/local/imserver/var/lib/ejabberd/.erlang.cookie

补充:
如果要确定一个ejabberd节点目前所使用的cookie, 可以./ejabberd debug进入debug模式
erlang:get_cookie()查看节点的cookie.

2. 在新增的ejabberd上运行
erl -name ejabberd@second_ip \
    -mnesia dir '"/usr/local/imserver/var/lib/ejabberd"' \
>mnesia:start().
>mnesia:change_config(extra_db_nodes, ['ejabberd@first_ip']).

执行之后, 可以调用mnesia:info()查看效果,
如果看到下面内容, 表示mnesia集群连接成功:
running db nodes = [ejabberd@first_ip, ejabberd@second_ip]

3. 在新增的ejabberd上运行:
mnesia:change_table_copy_type(schema, node(), disc_copies).

4. 根据自己的需要拷贝远程的表格到本地(修改属性ram_copies/disc_copies)
mnesia:add_table_copy(Tab, node(), Type)
mnesia:change_table_copy_type(Tab, node(), Type)

5. init:stop()退出erlang shell

6. 启动ejabberd.
